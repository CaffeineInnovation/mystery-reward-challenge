<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Mystery Reward Challenge</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap');
    body {
      font-family: "Poppins", Arial, sans-serif;
      background: radial-gradient(circle at center, #1c1c1c, #111);
      color: #fff;
      text-align: center;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin: 0;
      overflow: hidden;
      animation: bgPulse 6s infinite alternate ease-in-out;
    }
    @keyframes bgPulse {
      from { background: radial-gradient(circle at center, #1c1c1c, #111); }
      to { background: radial-gradient(circle at center, #282828, #111); }
    }
    h1 {
      margin-bottom: 10px;
      font-size: 4rem;
      color: #ffcc00;
      text-shadow: 0 0 20px #ffcc00, 0 0 40px #ffcc00;
      animation: glow 2s infinite ease-in-out alternate;
    }
    @keyframes glow {
      from { text-shadow: 0 0 10px #ffcc00, 0 0 20px #ffcc00; }
      to { text-shadow: 0 0 20px #ffe680, 0 0 50px #ffcc00; }
    }
    #score, #timer {
      font-size: 2.5rem;
      margin: 12px 0;
      letter-spacing: 1px;
      animation: fadeIn 1s ease forwards;
    }
    #button {
      background: linear-gradient(135deg, #ffcc00, #ffdd33);
      border: none;
      padding: 25px 80px;
      font-size: 2.5rem;
      font-weight: 700;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 0 #cc9900;
      margin-top: 20px;
    }
    #button:hover:not(:disabled) {
      transform: scale(1.1);
      background: linear-gradient(135deg, #ffe680, #fff176);
      box-shadow: 0 10px 20px rgba(255, 204, 0, 0.4);
    }
    #button:disabled {
      background: #777;
      box-shadow: none;
      cursor: not-allowed;
    }
    #message {
      margin-top: 25px;
      font-size: 2rem;
      min-height: 2.2em;
      transition: color 0.3s, transform 0.3s;
    }
    #leaderboard {
      margin-top: 40px;
      text-align: left;
      max-width: 400px;
      background: rgba(255, 255, 255, 0.08);
      padding: 20px;
      border-radius: 16px;
      backdrop-filter: blur(5px);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
      animation: slideUp 1s ease forwards;
    }
    #leaderboard h2 {
      font-size: 1.8rem;
      margin-bottom: 12px;
      border-bottom: 2px solid #ffcc00;
      padding-bottom: 5px;
      text-shadow: 0 0 10px #ffcc00;
    }
    #leaderboard ol {
      padding-left: 25px;
      margin: 0;
      font-size: 1.5rem;
      line-height: 1.6;
    }
    .flash { animation: flash 0.3s ease; }
    @keyframes flash { 0%{transform:scale(1);}50%{transform:scale(1.3);}100%{transform:scale(1);} }
    @keyframes fadeIn { from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);} }
    @keyframes slideUp { from{opacity:0;transform:translateY(50px);}to{opacity:1;transform:translateY(0);} }
  </style>
</head>
<body>
  <h1>üé∞ The Mystery Reward Challenge üé∞</h1>
  <div id="timer">‚è± Time: 15s</div>
  <div id="score">üíé Score: 0</div>
  <button id="button" disabled>Loading...</button>
  <div id="message"></div>

  <div id="leaderboard">
    <h2>üèÜ Top 5 Scores</h2>
    <ol id="scoresList">
      <li>...</li>
    </ol>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, get, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ‚úÖ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB1l0OT66U8Qm_o9Q-OqwG2yvQ0A2NjqMc",
      authDomain: "mystery-reward.firebaseapp.com",
      databaseURL: "https://mystery-reward-default-rtdb.firebaseio.com",
      projectId: "mystery-reward",
      storageBucket: "mystery-reward.appspot.com",
      messagingSenderId: "671463270943",
      appId: "1:671463270943:web:49d87ae2c3053788e8c32a",
      measurementId: "G-T3EM6RKRPC"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const button = document.getElementById("button");
    const scoreDisplay = document.getElementById("score");
    const timerDisplay = document.getElementById("timer");
    const message = document.getElementById("message");
    const scoresList = document.getElementById("scoresList");

    let score = 0;
    let timeLeft = 15;
    let timerInterval;
    let gameActive = false;
    let playerName = "";
    const sounds = {
      win: new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"),
      miss: new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg")
    };

    window.onload = async () => {
      playerName = prompt("Enter your name for the leaderboard:")?.trim() || "Anonymous";
      await loadLeaderboard();
      button.textContent = "Start Game";
      button.disabled = false;
      button.addEventListener("click", () => {
        if (!gameActive) startGame();
      });
    };

    function startGame() {
      score = 0;
      timeLeft = 15;
      gameActive = true;
      message.textContent = "";
      scoreDisplay.textContent = "üíé Score: 0";
      button.textContent = "Tap to Earn!";
      button.disabled = false;
      clearInterval(timerInterval);
      timerDisplay.textContent = `‚è± Time: ${timeLeft}s`;

      timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = `‚è± Time: ${timeLeft}s`;
        timerDisplay.classList.add("flash");
        setTimeout(() => timerDisplay.classList.remove("flash"), 200);
        if (timeLeft <= 0) endGame();
      }, 1000);
    }

    button.addEventListener("click", () => {
      if (!gameActive) return;
      const rand = Math.random();
      let reward = 0;
      if (rand < 0.2) reward = -1;
      else if (rand < 0.6) reward = 1;
      else if (rand < 0.85) reward = 5;

      if (reward > 0) {
        score += reward;
        message.textContent = `üéâ +${reward} points!`;
        message.style.color = "#00ff99";
        message.style.transform = "scale(1.2)";
        setTimeout(() => (message.style.transform = "scale(1)"), 200);
        playSound(sounds.win);
      } else if (reward === -1) {
        score = Math.max(0, score - 1);
        message.textContent = "üò¨ Oops! -1";
        message.style.color = "#ff4444";
        playSound(sounds.miss);
      } else {
        message.textContent = "üòÖ No reward";
        message.style.color = "#ffcc00";
        playSound(sounds.miss);
      }

      button.classList.add("flash");
      setTimeout(() => button.classList.remove("flash"), 200);
      scoreDisplay.textContent = `üíé Score: ${score}`;
    });

    async function endGame() {
      clearInterval(timerInterval);
      gameActive = false;
      button.disabled = true;
      button.textContent = "Game Over";
      message.textContent = `üéä ${playerName}, your final score: ${score}!`;
      message.style.color = "#ffcc00";

      // ‚úÖ Save score to Firebase
      const scoresRef = ref(db, "scores");
      await push(scoresRef, {
        name: playerName,
        score,
        timestamp: Date.now()
      });

      await loadLeaderboard();

      setTimeout(() => {
        button.textContent = "Play Again";
        button.disabled = false;
      }, 2000);
    }

    async function loadLeaderboard() {
      const leaderboard = document.getElementById("leaderboard");
      const scoresRef = query(ref(db, "scores"), orderByChild("score"), limitToLast(5));
    
      try {
        const snapshot = await get(scoresRef);
        const scoresArray = Object.values(snapshot.val())
          .filter(s => s && typeof s.score === "number")
          .sort((a, b) => b.score - a.score);
    
        if (scoresArray.length === 0) {
          leaderboard.style.display = "none";
          return;
        }
    
        // Show leaderboard and populate
        leaderboard.style.display = "block";
        scoresList.innerHTML = "";
        scoresArray.forEach((s) => {
          const li = document.createElement("li");
          li.textContent = `${s.name || "Anonymous"}: ${s.score}`;
          scoresList.appendChild(li);
        });
      } catch (err) {
        console.error("Error loading leaderboard:", err);
        leaderboard.style.display = "none";
      }
    }

    function playSound(sound) {
      sound.currentTime = 0;
      sound.play().catch(() => {});
    }
  </script>
</body>
</html>
